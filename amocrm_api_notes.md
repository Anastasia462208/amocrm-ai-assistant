# amoCRM API для получения примечаний

## Основные методы для получения истории переписки

### 1. Получение примечаний по конкретной сделке

**Метод:** `GET /api/v4/leads/{entity_id}/notes`

**Описание:** Метод позволяет получить примечания по ID сделки.

**Параметры:**
- `page` (int) - Страница выборки
- `limit` (int) - Количество возвращаемых сущностей за один запрос (Максимум – 250)
- `filter` (object) - Фильтр
- `filter[id]` (int|array) - Фильтр по ID примечаний
- `filter[note_type]` (string|array) - Фильтр по типу примечания
- `filter[updated_at]` (int|object) - Фильтр по дате последнего изменения примечания

### 2. Получение событий

**Метод:** `GET /api/v4/events`

**Описание:** Метод позволяет получить список событий в аккаунте.

**Полезные параметры для истории переписки:**
- `filter[entity]` - Фильтр по типу сущности (lead, contact, company)
- `filter[entity_id]` - Фильтр по ID сущности (ID сделки)
- `filter[type]` - Фильтр по типу событий
- `filter[created_at]` - Фильтр по дате создания события

## Типы примечаний, которые могут содержать сообщения

1. **common** - Обычные примечания (текстовые сообщения)
2. **call_in** - Входящие звонки
3. **call_out** - Исходящие звонки
4. **service_message** - Служебные сообщения
5. **mail_message** - Email сообщения
6. **message_cashier** - Сообщения кассира
7. **sms_in** - Входящие SMS
8. **sms_out** - Исходящие SMS

## Пример запроса для получения примечаний сделки

```bash
curl -X GET "https://SUBDOMAIN.amocrm.ru/api/v4/leads/12345/notes" \
  -H "Authorization: Bearer ACCESS_TOKEN" \
  -H "Content-Type: application/json"
```

## Пример ответа

```json
{
  "_page": 1,
  "_links": {
    "self": {
      "href": "https://example.amocrm.ru/api/v4/leads/12345/notes"
    }
  },
  "_embedded": {
    "notes": [
      {
        "id": 123456,
        "entity_id": 12345,
        "note_type": "common",
        "params": {
          "text": "Клиент интересуется сплавом по Чусовой"
        },
        "created_by": 123,
        "updated_by": 123,
        "created_at": 1640995200,
        "updated_at": 1640995200
      }
    ]
  }
}
```

## Стратегия импорта истории

1. **Получить список всех сделок** через API сделок
2. **Для каждой сделки получить примечания** через API примечаний
3. **Фильтровать примечания** по типам, содержащим сообщения
4. **Импортировать в базу данных** с сохранением структуры разговоров

## Ограничения

- Максимум 250 примечаний за один запрос
- Необходимо учитывать лимиты API (обычно 7 запросов в секунду)
- Требуется валидный ACCESS_TOKEN для авторизации
