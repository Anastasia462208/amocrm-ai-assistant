# AmoCRM AI Assistant для Турагентства

Система автоматизации диалогов с клиентами для турагентства речных сплавов с использованием Manus API для хранения данных и браузерной автоматизации для ответов в AmoCRM.

## 🎯 Возможности

- **Полная автоматизация** - обработка до 20 параллельных диалогов без участия менеджеров
- **Умные ответы** - контекстно-зависимые ответы на основе анализа сообщений клиентов
- **Хранение истории** - использование Manus API для долгосрочного хранения диалогов
- **Анализ контекста** - отслеживание намерений клиентов и готовности к бронированию
- **База знаний** - готовые ответы по турам, ценам, снаряжению и безопасности

## 🏗️ Архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   AmoCRM Chat   │◄──►│  Browser Auto    │◄──►│   Database      │
│                 │    │  (Selenium)      │    │   (SQLite)      │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │                        │
                                ▼                        ▼
                       ┌──────────────────┐    ┌─────────────────┐
                       │  Response Logic  │    │ Context Manager │
                       │   (Templates)    │    │  (AI Analysis)  │
                       └──────────────────┘    └─────────────────┘
                                │                        │
                                └────────┬───────────────┘
                                         ▼
                                ┌─────────────────┐
                                │   Manus API     │
                                │ (Long-term      │
                                │  Storage)       │
                                └─────────────────┘
```

## 📁 Структура проекта

```
amocrm-ai-assistant/
├── README.md                          # Документация проекта
├── requirements.txt                   # Python зависимости
├── database_schema.sql               # Схема базы данных
├── database_manager.py               # Управление базой данных
├── context_manager.py                # Анализ контекста диалогов
├── amocrm_automation_system.py       # Основная система автоматизации
├── manus_ai_assistant_simple.py      # Упрощенный AI ассистент
├── config/
│   ├── response_templates.json       # Шаблоны ответов
│   └── settings.py                   # Настройки системы
├── tests/
│   ├── test_database.py             # Тесты базы данных
│   ├── test_context_manager.py      # Тесты анализа контекста
│   └── test_automation.py           # Тесты автоматизации
└── docs/
    ├── installation.md              # Инструкция по установке
    ├── configuration.md             # Настройка системы
    └── api_reference.md             # Справочник API
```

## 🚀 Быстрый старт

### 1. Установка зависимостей

```bash
pip install -r requirements.txt
```

### 2. Настройка базы данных

```python
from database_manager import DatabaseManager

# Инициализация базы данных
db = DatabaseManager("conversations.db")
```

### 3. Настройка Manus API

```python
# В database_manager.py или через интерфейс
db.set_config('manus_api_key', 'your-manus-api-key')
```

### 4. Запуск системы

```python
from amocrm_automation_system import AmoCRMAutomationSystem

# Настройка
automation = AmoCRMAutomationSystem(
    amocrm_url="https://your-domain.amocrm.ru",
    login="your-login", 
    password="your-password"
)

# Запуск
automation.login_to_amocrm()
automation.monitor_chats()
```

## 🔧 Конфигурация

### Настройки AmoCRM

```python
AMOCRM_CONFIG = {
    'url': 'https://your-domain.amocrm.ru',
    'login': 'your-login',
    'password': 'your-password',
    'check_interval': 10,  # секунды между проверками
}
```

### Настройки Manus API

```python
MANUS_CONFIG = {
    'api_key': 'sk-your-api-key',
    'base_url': 'https://api.manus.im/v1/tasks',
    'mode': 'fast',  # или 'quality'
}
```

## 📊 Мониторинг и метрики

Система предоставляет следующие метрики:

- **Активные диалоги** - количество текущих диалогов
- **Сообщения за день** - обработанные сообщения
- **Готовность к бронированию** - оценка намерений клиентов (0-10)
- **Качество ответов** - анализ эффективности ответов

```python
# Получение статуса системы
status = automation.get_system_status()
print(f"Активных диалогов: {status['active_conversations']}")
```

## 🎯 Типы ответов

### 1. Приветствие
- Автоматическое распознавание приветствий
- Дружелюбные ответы с представлением компании

### 2. Информация о турах
- Описание сплавов по Чусовой и Серге
- Цены и продолжительность
- Подходящие категории клиентов

### 3. Цены и бронирование
- Актуальные цены на туры
- Что включено в стоимость
- Процесс бронирования

### 4. Снаряжение и безопасность
- Что взять с собой
- Требования к участникам
- Меры безопасности

### 5. Даты и логистика
- Доступные даты
- Трансфер и встреча
- Погодные условия

## 🔍 Анализ контекста

Система анализирует:

- **Намерения клиента** - что хочет клиент (информация, бронирование, сравнение)
- **Извлеченные сущности** - даты, количество участников, предпочтения
- **Состояние диалога** - этап разговора (знакомство, выбор, бронирование)
- **Готовность к покупке** - оценка вероятности бронирования

```python
# Анализ сообщения
intents = context_manager.analyze_message_intent(message)
entities = context_manager.extract_entities(message)
```

## 🗄️ База данных

### Основные таблицы:

- **clients** - информация о клиентах
- **conversations** - диалоги и их состояние
- **messages** - все сообщения
- **ai_tasks** - задачи для AI
- **knowledge_base** - база знаний
- **booking_requests** - запросы на бронирование

### Пример запроса:

```sql
SELECT c.name, COUNT(m.id) as message_count
FROM clients c
JOIN conversations conv ON c.id = conv.client_id  
JOIN messages m ON conv.id = m.conversation_id
WHERE DATE(m.timestamp) = DATE('now')
GROUP BY c.id;
```

## 🔒 Безопасность

- Все пароли и API ключи хранятся в зашифрованном виде
- Логирование всех действий для аудита
- Ограничение доступа к базе данных
- Безопасное подключение к внешним API

## 📈 Масштабирование

Система готова к масштабированию:

- **До 200 диалогов** - изменение параметров мониторинга
- **Множественные операторы** - поддержка нескольких браузерных сессий
- **Кластеризация** - распределение нагрузки между серверами

## 🛠️ Разработка

### Добавление новых типов ответов:

```python
# В amocrm_automation_system.py
self.response_templates['new_category'] = [
    "Новый шаблон ответа 1",
    "Новый шаблон ответа 2"
]
```

### Добавление анализа намерений:

```python
# В context_manager.py
self.intent_patterns['new_intent'] = [
    r'ключевое слово 1',
    r'ключевое слово 2'
]
```

## 📞 Поддержка

Для получения поддержки:

1. Создайте issue в GitHub репозитории
2. Опишите проблему с примерами логов
3. Укажите версию системы и конфигурацию

## 📄 Лицензия

MIT License - см. файл LICENSE для деталей.

## 🤝 Вклад в проект

Приветствуются pull requests! Пожалуйста:

1. Форкните репозиторий
2. Создайте feature branch
3. Добавьте тесты для новой функциональности
4. Убедитесь, что все тесты проходят
5. Создайте pull request

---

**Разработано для турагентства "Все на сплав"** 🚣‍♂️
