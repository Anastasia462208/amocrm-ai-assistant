# Руководство по интеграции с базой данных

## Обзор

Система теперь включает полную интеграцию с базой данных для хранения истории переписки с привязкой к ID сделки из amoCRM. Все сообщения от клиентов и ответы ассистента сохраняются в SQLite базе данных.

## Новые файлы

### 1. `amocrm_manus_webhook_with_db.py`
**Основной веб-хук сервер с интеграцией базы данных**

Функциональность:
- Принимает веб-хуки от amoCRM
- Извлекает ID сделки, текст сообщения и время создания
- Автоматически создает клиентов и разговоры в базе данных
- Сохраняет все входящие сообщения от клиентов
- Использует историю переписки для генерации контекстных ответов
- Сохраняет ответы ассистента в базу данных
- Ведет подробную статистику

Запуск:
```bash
python3 amocrm_manus_webhook_with_db.py
```

### 2. `view_database.py`
**Утилита для просмотра содержимого базы данных**

Возможности:
- Показывает всех клиентов, разговоры и сообщения
- Отображает историю переписки по разговорам
- Предоставляет статистику использования
- Поиск сообщений по конкретной сделке

Использование:
```bash
# Показать всю базу данных
python3 view_database.py

# Показать сообщения для конкретной сделки
python3 view_database.py 12345
```

### 3. `test_webhook_with_db.py`
**Тестирование веб-хука через HTTP запросы**

Отправляет тестовые сообщения на веб-хук сервер, имитируя поведение amoCRM.

Запуск:
```bash
python3 test_webhook_with_db.py
```

### 4. `simple_webhook_test.py`
**Упрощенное тестирование интеграции с базой данных**

Тестирует функциональность базы данных напрямую, без HTTP запросов.

Запуск:
```bash
python3 simple_webhook_test.py
```

## Структура базы данных

Система использует существующую схему базы данных из `database_schema.sql`:

### Таблица `clients`
- `id` - уникальный идентификатор клиента
- `amocrm_contact_id` - ID контакта из amoCRM
- `name` - имя клиента
- `phone`, `email` - контактная информация

### Таблица `conversations`
- `id` - уникальный идентификатор разговора
- `client_id` - ссылка на клиента
- `amocrm_lead_id` - **ID сделки из amoCRM** (ключевое поле)
- `status` - статус разговора (active, completed)
- `last_activity` - время последней активности

### Таблица `messages`
- `id` - уникальный идентификатор сообщения
- `conversation_id` - ссылка на разговор
- `sender_type` - тип отправителя ('client' или 'assistant')
- `content` - текст сообщения
- `message_type` - тип сообщения ('text')
- `metadata` - дополнительные данные в JSON формате
- `timestamp` - время создания сообщения

## Процесс обработки сообщений

1. **Получение веб-хука** от amoCRM с данными сообщения
2. **Извлечение данных**:
   - ID сделки из `entity_id`
   - Текст сообщения из `text`
   - Время создания из `created_at`
3. **Работа с базой данных**:
   - Создание или поиск клиента по ID сделки
   - Создание или поиск разговора для этого клиента
   - Сохранение сообщения от клиента
4. **Генерация ответа**:
   - Получение истории переписки для контекста
   - Отправка запроса в Manus API с учетом истории
   - Генерация ответа (локально как fallback)
5. **Отправка ответа**:
   - Добавление примечания в amoCRM
   - Сохранение ответа ассистента в базу данных

## Метаданные сообщений

Каждое сообщение содержит метаданные в JSON формате:

### Для сообщений от клиентов:
```json
{
  "amocrm_lead_id": 12345,
  "amocrm_timestamp": 1758650960,
  "source": "amocrm_webhook"
}
```

### Для ответов ассистента:
```json
{
  "amocrm_lead_id": 12345,
  "source": "ai_response"
}
```

## Статистика

Система ведет подробную статистику:
- Количество полученных сообщений
- Количество сохраненных в БД сообщений
- Количество запросов к Manus API
- Количество отправленных ответов
- Количество ошибок
- Время работы сервера

## Примеры использования

### Просмотр всей истории переписки
```bash
python3 view_database.py
```

### Поиск сообщений по конкретной сделке
```bash
python3 view_database.py 12345
```

### Запуск полного тестирования
```bash
# Запустить сервер
python3 amocrm_manus_webhook_with_db.py &

# В другом терминале запустить тесты
python3 test_webhook_with_db.py

# Просмотреть результаты
python3 view_database.py
```

## Преимущества новой системы

1. **Полная история переписки** - все сообщения сохраняются с привязкой к сделкам
2. **Контекстные ответы** - ИИ видит предыдущие сообщения при генерации ответов
3. **Аналитика** - возможность анализировать общение с клиентами
4. **Надежность** - данные не теряются при перезапуске сервера
5. **Масштабируемость** - поддержка множественных параллельных разговоров
6. **Мониторинг** - подробная статистика работы системы

## Файл базы данных

База данных сохраняется в файл `conversations.db` в директории проекта. Этот файл содержит всю историю переписки и может быть скопирован для резервного копирования или анализа.

## Совместимость

Новая система полностью совместима с существующей инфраструктурой:
- Использует тот же формат веб-хуков от amoCRM
- Сохраняет тот же API для отправки ответов
- Добавляет функциональность без нарушения существующих процессов
